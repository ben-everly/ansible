---
- hosts: all
  vars:
    docker_compose_version: v2.15.1
    ansible_python_interpreter: /usr/bin/python3
    apt_packages:
      - automake
      - cryptsetup
      - dconf-editor
      - fonts-firacode
      - gnome-tweaks
      - gnupg
      - libnss3-tools
      - libc6-x32
      - libc6-i386
      - make
      - pass
      - pass-extension-tomb
      - pinentry-curses
      - pkg-config
      - python3
      - python3-gpg
      - python3-pip
      - universal-ctags
  roles:
    - role: geerlingguy.docker
      become: true
    - role: enpass
      become: true
    - role: oberd
      become: true
    - role: cli-dev-tools
      become: true
    - role: neovim
    - role: cimon-io.asdf
      asdf_user: ben
      asdf_group: ben
      asdf_apt_optional_dependencies:
       - libsqlite3-dev
       - libgd-dev
       - libonig-dev
       - libpq-dev
       - libzip-dev
      asdf_plugins:
      - name: golang
        repository: https://github.com/kennyp/asdf-golang.git
        versions: [ "latest" ]
        global: "latest"
      - name: nodejs
        versions: [ "latest" ]
        global: "latest"
      - name: php
        versions: [ "latest" ]
        global: "latest"
      - name: java
        repository: https://github.com/halcyon/asdf-java.git
        versions: [ "latest:openjdk" ]
        global: "latest"
      - name: ruby
        versions: [ "latest" ]
        global: "latest"
      - name: python
        versions: [ "2.7.18" ]
        global: "2.7.18"
    - role: spotify
      become: true
    - role: dropbox
      become: true
    - role: gh-cli
      become: true
    - role: dbxcli
    - role: aws
    - role: jet
    - role: pop-shell
    - role: vim-anywhere
    - role: chrome
      become: true
  tasks:
      - name: apt installs
        become: yes
        block:
          - name: Install apt packages
            apt:
              name: "{{ apt_packages }}"
              state: latest
              update_cache: yes

          - name: apt cleanup
            apt:
              autoremove: yes

      - name: install tomb
        block:
          - name: download tomb
            get_url:
              url: https://files.dyne.org/tomb/releases/Tomb-2.9.tar.gz
              dest: ./tmp/tomb.tar.gz
            register: tomb_file

          - name: unzip tomb_file
            when: tomb_file.changed
            shell: tar xvfz ./tomb.tar.gz
            args:
              chdir: ./tmp

          - name: run make
            become: true
            when: tomb_file.changed
            make:
              chdir: ./tmp/Tomb-2.9
              target: install

      - name: install javaSE
        block:
          - name: download javaSE
            get_url:
              url: https://download.oracle.com/java/17/latest/jdk-17_linux-x64_bin.deb
              dest: ./tmp/javaSE.deb
            register: javaSE_file

          - name: install javaSE
            become: yes
            when: javaSE_file.changed
            apt: deb="./tmp/javaSE.deb"
